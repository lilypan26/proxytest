#!/usr/bin/env bash
set -x

echo "setting up"
WORKDIR="${1:-$(mktemp -d)}"
echo "setting up ${WORKDIR}"

pushd "$WORKDIR"

apt update -y && apt install -y apt-transport-https curl gnupg make gcc < /dev/null

# add diladele apt key
wget -qO - https://packages.diladele.com/diladele_pub.asc | apt-key add -

# add new repo
tee /etc/apt/sources.list.d/squid413-ubuntu20.diladele.com.list <<EOF
deb https://squid413-ubuntu20.diladele.com/ubuntu/ focal main
EOF

# and install
apt-get update && apt-get install -y squid-common squid-openssl squidclient libecap3 libecap3-dev < /dev/null

mkdir -p /var/lib/squid

/usr/lib/squid/security_file_certgen -c -s /var/lib/squid/ssl_db -M 4MB || true

chown -R proxy:proxy /var/lib/squid

# Name of the VM on which Squid is hosted
HOST="10.42.3.4"

CACERT="LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZQRENDQXlTZ0F3SUJBZ0lVQ3ZMTzdVN2ZhU294WW1VSkh5cWEwTU5PWlFjd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0ZERVNNQkFHQTFVRUF3d0pNVEF1TkRJdU15NDBNQjRYRFRJek1Ea3hPREU0TlRneU5sb1hEVE16TURreApOVEU0TlRneU5sb3dGREVTTUJBR0ExVUVBd3dKTVRBdU5ESXVNeTQwTUlJQ0lqQU5CZ2txaGtpRzl3MEJBUUVGCkFBT0NBZzhBTUlJQ0NnS0NBZ0VBNHlZaEJzemlaNDNVcjc2VUZ2ZUdrVlllRmJ0QXJGUTB6NUdFbnliRW5ib2IKbyt2YzB5RzAvNUdRSW9qNFkxS0s1cHhjaXdjYmIvTUZjdkJZM3RrTVZ1ME95bittRXVoRnZMYldLbWpOUW9HcQpqQlRyMEFVc3dSb3R6MC8xNUpDbE5QMlZ4Z0x5U200V0xCaHN5aWFuLzVvd1plM1pWVU5YUDJSZGxzYlN0THpPCmoycDlFUnNaTW0rMHMvUVJ3M0xiQWRudURiQ3NESVRJZzl3cmFMQmRCR01rL0IyUkpLeGxpTUFQZnRBY2Ivam4KcHI5aGkwTFRiRk1kUEt3bnNtdzFmd2x4anNkVWlKRnBZMEYzenFMS0FwdDByZHgrcHgzU3AwUzRENmwwTzU3RQpiN3U1dXNPVmlQcGxWRmRaK1dwaWtJeHZKWW1GSjNoaTg3QUR0bkJSajlDajJQVUtUb3VocFVrMTNCVXU0WDZkCkJRUXBVZ21TdEVtdEc1aEhTRE9oQStXUGxLbEQyZ2UrMU5oSzBsdG91ZG9YNkN1UFFFcDc5YXlYcVNSNFVHdFEKUlhzcTMxOENDUmV1WUhBR2pwcDV2VCtKaGNDeTNDVDlhRGY3RHNLZFRTVTYyUTZML0U2ajhRWUpTVXJrTklXUAowZUQ2Z05VMktTV05pS2hqVWFCQi9tNWFjc21wRGNmNGRqb0d6YVJza3ZWcW4zZUVqRHZmTWtEa3oxaWxaOHlJCkwwK25XcVFGYXpGYmFOUHBwMkpzMFpUaXJ6b1AvMzFjWjQxUlFFS3YyNlpMNWJ2WW5oRDdZeWdPWC9menpJUXYKTVQ1YlhEVkkySmR0VTYwSU50b3NLRCtXS0hxYWF0SGdkdVBzYUFaazd6Y3NoUTFuOU1OL0RvYWEzRHQ1ZXVFQwpBd0VBQWFPQmhUQ0JnakFkQmdOVkhSRUVGakFVaHdRS0tnTUVnZ3hqYkdrdGNISnZlSGt0ZG0wd0VnWURWUjBUCkFRSC9CQWd3QmdFQi93SUJBREFQQmdOVkhROEJBZjhFQlFNREIrZUFNQjBHQTFVZEpRUVdNQlFHQ0NzR0FRVUYKQndNQ0JnZ3JCZ0VGQlFjREFUQWRCZ05WSFE0RUZnUVVhVFJvKzNMY3dlNmthTUNBU1BGTnVOVFpqT2N3RFFZSgpLb1pJaHZjTkFRRUxCUUFEZ2dJQkFLWkllOHR1YkVEcTdIZFRHODIzMDA3cG83aWgyL2Y0bUhnRmhUL3RmQjhHCnJxMlRZb0pHMnVHd0g2ei9xMUQwZzNyOUQ0MWphYkdqM1FicGd1SVFiMnlwZ0xFRG1FQnA2WlhFNnNZUjZ0KzEKTXBXWXpyRHNGVVJIejN2WTlOcWJjVFk5VVh4ZFZHVEpSNWxWQm15UUZRN3ZmT3Z2cjBnQk5aWUhCL0M0VG1pWgpCSGlObC8xaUZsbXFVV3ArZ21MZVlJd0NVVUdhd29sbGNzOFJZZHFxeFk2MXNTMHg1RVQwbmpuWFVJRTlUV3NPCldMeXE5MmE5emFIdmRJMFB5S0w0SERwNHY1QzM3ZVA2TVd1THBSLzBmaE9tcnZ1cEd0RUxFOUk4dURpMmhzV0cKN1phVmx0QnVwSktUSWE2V3pkNU1jVmp5bFY2RVFzYlY5ZHhLTHZmR1Vrc0dNSU5zci9YL1BjSmQ4RVZZQ0NDYQpXbHF2dVFEcXA5Y0RjcDBjYUhsR2pzYUVRa1RvUzEzT1Nxc1VsRU1xRnNvZnJydm92Y2xPcWR3WU5RS1k4TzE3CnRIcHJtTWVXaWhGTU1PWHBzbWlESGhLcU1YNTJwYVJQSzVOY3ZTZS9mSzZrZEVGcHM4MVQzOXo1VVY2YW9hdDAKR3Z6bFRWZHdpZDM0TTlTMm5JTXhSNUJXN0s2YnFaTXQzUUVDUFhtT25tTUxQUmtoamFUVkpJVVFFK0Z0VlhBZwpXUndZM2V2dmlCUDl3ZWFCOTJiZXBnM0dQYi9JREw4dmw5cFAvY2kvZVl4dEI0cGRCaFhac1lUWTg0YkFza0R5Cm1Mc05jekFPZ1B5bXBSdzVvZFA4a2dOcVJoYUpGNkpiQzluWkZUSk1CMTFoZVVJUDdMbm44eU4wNkNpUWViMTIKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
CAKEY="LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUpRd0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQ1Mwd2dna3BBZ0VBQW9JQ0FRRGpKaUVHek9KbmpkU3YKdnBRVzk0YVJWaDRWdTBDc1ZEVFBrWVNmSnNTZHVodWo2OXpUSWJUL2taQWlpUGhqVW9ybW5GeUxCeHR2OHdWeQo4RmplMlF4VzdRN0tmNllTNkVXOHR0WXFhTTFDZ2FxTUZPdlFCU3pCR2kzUFQvWGtrS1UwL1pYR0F2SktiaFlzCkdHektKcWYvbWpCbDdkbFZRMWMvWkYyV3h0SzB2TTZQYW4wUkd4a3liN1N6OUJIRGN0c0IyZTROc0t3TWhNaUQKM0N0b3NGMEVZeVQ4SFpFa3JHV0l3QTkrMEJ4ditPZW12MkdMUXROc1V4MDhyQ2V5YkRWL0NYR094MVNJa1dsagpRWGZPb3NvQ20zU3QzSDZuSGRLblJMZ1BxWFE3bnNSdnU3bTZ3NVdJK21WVVYxbjVhbUtRakc4bGlZVW5lR0x6CnNBTzJjRkdQMEtQWTlRcE9pNkdsU1RYY0ZTN2hmcDBGQkNsU0NaSzBTYTBibUVkSU02RUQ1WStVcVVQYUI3N1UKMkVyU1cyaTUyaGZvSzQ5QVNudjFySmVwSkhoUWExQkZleXJmWHdJSkY2NWdjQWFPbW5tOVA0bUZ3TExjSlAxbwpOL3NPd3AxTkpUclpEb3Y4VHFQeEJnbEpTdVEwaFkvUjRQcUExVFlwSlkySXFHTlJvRUgrYmxweXlha054L2gyCk9nYk5wR3lTOVdxZmQ0U01POTh5UU9UUFdLVm56SWd2VDZkYXBBVnJNVnRvMCttblltelJsT0t2T2cvL2ZWeG4KalZGQVFxL2Jwa3ZsdTlpZUVQdGpLQTVmOS9QTWhDOHhQbHRjTlVqWWwyMVRyUWcyMml3b1A1WW9lcHBxMGVCMgo0K3hvQm1Udk55eUZEV2YwdzM4T2hwcmNPM2w2NFFJREFRQUJBb0lDQUVSZmdzdDRPcUl2R0JrNmhYc1FVT3BJCmdNL0x5S0RXeS9xNjg2K3dUTGlwZjQ1cy9kQnpzZmJIeXhvS0hySk84MDZOUEhJQTFxcHcvVy9tbHVtbGJjaHcKbk9ZcFhFVU9zNGNsaGZ2SUJoa0J6T05Ubk5QRjZ2M0pNb2JYcTgxOEdLNkZzbUtqR21sN0Q2T0FTcWJpMGVqbgpjYkFNMDBHTi9xSXZSTmlReW5YcTYwWlNLSWxRbmRvSHM5NERGcUc5WGQwRnkxbEZsOVJBMTlhUkhHUHJ5bVA2CnIvUlB0aFBTN05FbjlzSVdSS2tUeEM3MkpwZHpxdzVOU2x5citWc0VwV215M3dLNlQyQzRYSCtyQWpRcDNpTEEKeG5OYkRxaWhHbnFNL2RhQkRHS3gzTEZCVVp1OUtiTE1wRm1wM1lSdEdIUW9RWUNNRDQrYzlqUWlCRXdUTFFsSworTUdGRHZwWVF2cmNxaU5qQVdOWmluWUdaVFlqb0crbzZCSXRQekZna3RVUHYzbmtCeVFRQ2pMNkRmaVptMUdxCnVRN0FuR1J4ZVMxMlFGREJUanhTQ0pzS3R5WXlFQU0zMjRrTVNiUWhOMENqNldNVkd1eS85UE8xQmhPMnN2bk8KQ2FoRUV1SStrYmVFTVFSNXg3Tjk3MmpxVFZYalBpK2xTSmxIYUFFdCtLdGpPSkZWVWFidTROUkduL2N5eVJFWApHdmxscDhTTXZkZzk0RFpIYVVqMDYwd0JHeHlGTFYvS3NOQ1dyTWpaUTFPdi92MXNtSjBidnB2VUMrUHBqS0Z4CmtIWXBDV1d5QlM4VEw2MHQ5Q3NROUV3TXg1YWdFcTlqRzdhUWJlQ1lrK1Q4NUtFTTR2M0R1YlRnUDVNU1ppRVoKUHExczNxaFViT3RZL3NkMzllQ3RBb0lCQVFEeHdUMWlXRS9TVVh0ZndVdHd5dU5hbjhkaldmNU1qZitTTUdrcgpVejR5SXpQbkRxT3EvN0pJZnVNZXhNa2VtUHIyaHVIb3drQThIWXpBYXFVUGFsRnVuZGFYeTFLK1N6WDEwWVJoCmZ5U0RXM3lOekIxclFUTS9qeDRTNG9seVJHaVRwd0dUalR6V29zYndSRnJibmFGalEyaVdIS3RjYVI1R3QwbEMKMEZMY2Uyb0g5TGVpL0cwbS9pMjhxdmhCVVZkZmw4R0QvRWNaRUNIcG5qVGtDNWtQTVQzaDdYa3JQZmhSUWNsSApjWkZ4TjZhUDVvR1RFVmVUQXNsQTd3NVFNcFBZRW5tMXhGalM0TUFaOTR3enhodW5UUXd6M0x3bHFDWUVidEFNCjF4Y29RaCtJRzlJdS94VGlGK29EclVQSDFkcmxzZXZRSHZQWHBmQUtwc2trMjVSTEFvSUJBUUR3aUpEaDNNTXUKZ1dXNmFjZkVaU2YwTHhRZHZOcU1CYkEvaDZsZENkdkl4MVVyeGlDUGxYU3krNlUxVE5tdWkxQk1Gb09jaGRpSwo0Rm5NY3hyNmxOaXBnR1J2K21GMmpIb0lia1VIOXp1bGE2WjFlVVBCLzJYZTd1SnJRTVFxUUJtWDA1VGIrL3JMClczSDZ4UmRuOTU1Sk95MzZTY25JOG1FTytwb3ZUTlZLUmREY3BVa3Y5QUxzZTFOcEdTaklEVlg2Zjk4bVpvb3gKbGEzY2JhWklWQmJ4RnRMei9HNnZiVnlodVY1QkhuVjBEY3ZKL3NTdmhTNUdyRkJ3cFRXbktidllOOHBaSE5hLwo5SEdveEZPcEt5V256VnJ5Y0pEVWpVQjRDaFMvU3RnYmNCdERpRGt1VVJ4cHBVVklIQnkwZXNPQk9ZWEVQdzkrCldBTXh3dS9sMFhvREFvSUJBR29leVROQ1VNZWh2T1pya3hJUC9YenFaanZXWlNwMXFwb2haZ2orb1c2Z3hVZkgKeFZCcXJYZmxPdzFtbEdJNkJPL3loWGdHek91V2pSSnB2Y3JtZ0podDhLVHhPNEVNd3NNRkZYYzJ1SEJ3MkZ2bQpIWVBYT3dmTGF3Z2ZLUFpmMFFmL1oxRzl6ZGJwM1NuYTE0ZFB5bWdvVHVDVjlTSzdnZTdJeGYvdU1uRldPMVVDCnR4bDBkUFdJM2NyVHdlWHFMdEJuYlNyaXN0THRvZlZLM1N5OWFwS2dxdWxodEs2bXBUb0dCclMxeFlKTlMzQWYKWHdHUHUwRnRGNnJKUlI4dkZIYmtwVWlFeC9qSmI0bjJnRFM1NGFtdXlJeDdlSnVQRkNFZUEzV2ZkU3JXMjhDRApkZC9yV045bVgvTDlPNk9jM0ZtM29DdmJhbTVmQ04ra0Z1ZDIrOEVDZ2dFQkFNODJOdW44anNDZmhJMkUxeTJmCm56M0MyT2VOYkJDNFRjOU5CV0E3UC9YRmt0LzAvTlAxQXVXMTErc0UyM3A4Vlo1V3Z1YTJmNGVVSW9mNG1VTkoKdXlTNmtNdk92T3V0dE90U1kzR3JVTnorMGhYZGM3dktVMjRzQ1M0d1MwM0Nqc20yNGtSbzNQTVhRaWV3WnF1UQpLL0lXWTFOOUFiSjA2NXhGMDFId05NYVpRb2J5ZFF3MGY5aE5uZHVxYXZGOFc1ZERWVy8xWWhPNVNGL2VyaU1kCkhlNXZwU2UvVFhNZkdXL1JDeHU2SzZEZ3liQ29JN1M1WE5aUlY3TFRBRmVUb2xsd0pvZUNTcFp1OVFOWXJtSEwKNDlLZEhENURMdUdORmY3VFlIQXkvOTBUUk1sMnJ4dnhrREtLeUJhSThVbWhnSTd3aVFZNDlSWDRxRGZVSVdxdwpmUlVDZ2dFQkFOUGJDRFgzbVVsQ2tjeTFBc1J3c01BdHUrWWlUaS92dnNmN3ptQTlrcnJpQTdHeUZaQTN0OC9hClVjbGRLWnBWTWpRaXpsL21peXNWUHhXMDRnL0xucDJJUlFQN2F0d0ZXaW4rb1hlellaL1lMbHFqYitjSWZLSmgKWG1lZzY1ZXNMV3VsVndiNzVKUUUyc3dWWWhBL2FVdHI3SmROdXFRcEhYWk0rTk8xa1NGeGwzK0FKSFA2dHFSaAo4Vy8rcUd1dXYzVkNWL2RMMEVvM0g5MnBIaDEwZzk0YWJkMVhMMHNOU0o3QTl5QTA2eTZzYzBucGtKdHMzVWQ2CmJJUnEwZnV3K1NPc1ZmQUtUQU5kWW1saVFvZy9NbXBOMkFpdUpNdjBwYm5yekphdmx0L0tCRlIyejlGaDQzNzcKM0prbWpZVElJeVlUTGxWRHZ5VlBKeFlwSUh4ZEY2RT0KLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo="

echo "$CAKEY" | base64 -d > squidk.pem
echo "$CACERT" | base64 -d > squidc.pem

chown proxy:proxy squidc.pem
chown proxy:proxy squidk.pem
chmod 400 squidc.pem 
chmod 400 squidk.pem
cp squidc.pem /etc/squid/squidc.pem
cp squidk.pem /etc/squid/squidk.pem
cp squidc.pem /usr/local/share/ca-certificates/squidc.crt
update-ca-certificates 

sed -i 's~http_access deny all~http_access allow all~' /etc/squid/squid.conf
sed -i "s~http_port 3128~http_port $HOST:3128\nhttps_port $HOST:3129 tls-cert=/etc/squid/squidc.pem tls-key=/etc/squid/squidk.pem~" /etc/squid/squid.conf

systemctl restart squid
systemctl status squid

curl -fsSl -o /dev/null -w '%{http_code}\n' -x http://${HOST}:3128/ -I http://www.google.com
curl -fsSl -o /dev/null -w '%{http_code}\n' -x http://${HOST}:3128/ -I https://www.google.com
curl -fsSl -o /dev/null -w '%{http_code}\n' -x https://${HOST}:3129/ -I http://www.google.com
curl -fsSl -o /dev/null -w '%{http_code}\n' -x https://${HOST}:3129/ -I https://www.google.com
